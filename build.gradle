apply plugin: 'java'

buildscript {
    repositories {
        jcenter()
    }
    dependencies {
        classpath group: 'commons-io', name: 'commons-io', version: '2.5'
        classpath group: 'org.zeroturnaround', name: 'zt-zip', version: '1.9'
    }
}

allprojects {
    apply plugin: 'java'
    
    ext.android_platform = "$sdkdir/platforms/android-$sdkver"
    ext.android_tools_lib = "$sdkdir/tools/lib"
    ext.core_jar_path = "$rootDir/mode/processing-core.zip"

    repositories {
        jcenter()
        flatDir dirs: "$rootDir/core/library"
        flatDir dirs: "$rootDir/core/build/libs"
        flatDir dirs: "$rootDir/mode/libraries/vr/library"
        flatDir dirs: android_platform
        flatDir dirs: android_tools_lib
    }

    sourceCompatibility = 1.7
    targetCompatibility = 1.7
}

dependencies {
    compile name: 'android'
    compile project(":core")
    compile project(":mode:libraries:vr")
    compile project(":mode")     
}


clean.doFirst {
    delete "dist"
}

import java.nio.file.Files
import org.zeroturnaround.zip.ZipUtil
import org.apache.commons.io.FileUtils
import static java.nio.file.StandardCopyOption.*;

task dist {
  dependsOn subprojects.build
  doLast {
        def root = "$buildDir/zip/AndroidMode"
        
        // Copy assets to build dir
        FileUtils.copyDirectory(file("mode/templates"), file("$root/templates"))
        FileUtils.copyDirectory(file("mode/examples"), file("$root/examples"))
        FileUtils.copyDirectory(file("mode/icons"), file("$root/icons"))
        FileUtils.copyDirectory(file("mode/mode"), file("$root/mode"))
        FileUtils.copyDirectory(file("mode/theme"), file("$root/theme"))
                   
        Files.copy(file("core/build/libs/processing-core.zip").toPath(),
                   file("$root/processing-core.zip").toPath(), REPLACE_EXISTING);

        Files.copy(file("mode/mode.properties").toPath(),
                   file("$root/mode.properties").toPath(), REPLACE_EXISTING);

        FileUtils.copyDirectory(file("mode/tools/SDKUpdater/tool"), 
                                file("$root/tools/SDKUpdater/tool"))
        FileUtils.copyDirectory(file("mode/tools/SDKUpdater/src"), 
                                file("$root/tools/SDKUpdater/src"))
        
        FileUtils.copyDirectory(file("mode/libraries/vr/examples"), 
                                file("$root/libraries/vr/examples"))
        FileUtils.copyDirectory(file("mode/libraries/vr/gvrsdk"), 
                                file("$root/libraries/vr/gvrsdk"))
        FileUtils.copyDirectory(file("mode/libraries/vr/library"), 
                                file("$root/libraries/vr/library"))
        FileUtils.copyDirectory(file("mode/libraries/vr/src"), 
                                file("$root/libraries/vr/src"))
        Files.copy(file("mode/libraries/vr/library.properties").toPath(),
                   file("$root/libraries/vr/library.properties").toPath(), REPLACE_EXISTING);                             

        File distFolder = file("dist");
        //create intermediate folder if they don't exist
        distFolder.mkdirs();
        ZipUtil.pack(file("$buildDir/zip"), new File("dist/AndroidMode.zip"));
        Files.copy(file("mode/mode.properties").toPath(),
                   file("dist/AndroidMode.txt").toPath(), REPLACE_EXISTING);
    }
}

